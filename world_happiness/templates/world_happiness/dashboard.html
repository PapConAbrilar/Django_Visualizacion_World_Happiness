{% extends 'world_happiness/base.html' %}

{% block container %}
<div class="container">
    <h1>Dashboard Interactivo - World Happiness 2015</h1>
    <p>Explora y compara métricas de felicidad entre países</p>

    <!-- Filtros -->
    <div class="filters">
        <label for="selectRegion">Filtrar por Región:</label>
        <select id="selectRegion">
            <option value="all">Todas las Regiones</option>
            {% for region in regiones %}
            <option value="{{ region }}">{{ region }}</option>
            {% endfor %}
        </select>

        <label for="selectMetric">Métrica Principal:</label>
        <select id="selectMetric">
            {% for metrica in metricas %}
            <option value="{{ metrica }}">{{ metrica }}</option>
            {% endfor %}
        </select>

        <label for="selectTopN">Número de Países:</label>
        <select id="selectTopN">
            <option value="5">Top 5</option>
            <option value="10" selected>Top 10</option>
            <option value="20">Top 20</option>
        </select>

        <button onclick="updateCharts()">Aplicar Filtros</button>
    </div>

    <!-- Gráficos -->
    <div class="charts">
        <div id="barChart" style="width: 100%; height: 400px;"></div>
        <div id="scatterPlot" style="width: 100%; height: 400px;"></div>
    </div>

    <!-- Tabla de Datos -->
    <div class="table-container">
        <h3>Datos Detallados</h3>
        <table id="dataTable">
            <thead>
                <tr>
                    <th>País</th>
                    <th>Región</th>
                    <th>Felicidad</th>
                    <th>GDP</th>
                    <th>Familia</th>
                    <th>Salud</th>
                    <th>Libertad</th>
                </tr>
            </thead>
            <tbody id="tableBody">
                <!-- Los datos se cargarán aquí -->
            </tbody>
        </table>
    </div>
</div>

<!-- Incluir Plotly -->
<script src="https://cdn.plot.ly/plotly-latest.min.js"></script>

<script>
// Datos desde Django
const happinessData = {{ datos_json|safe }};
let currentFilters = {
    region: 'all',
    metric: 'Happiness Score',
    topN: 10
};

// Inicializar cuando la página cargue
document.addEventListener('DOMContentLoaded', function() {
    updateCharts();
});

function updateCharts() {
    // Actualizar filtros
    currentFilters.region = document.getElementById('selectRegion').value;
    currentFilters.metric = document.getElementById('selectMetric').value;
    currentFilters.topN = parseInt(document.getElementById('selectTopN').value);
    
    // Filtrar datos
    let filteredData = happinessData;
    if (currentFilters.region !== 'all') {
        filteredData = happinessData.filter(d => d.Region === currentFilters.region);
    }
    
    // Actualizar gráficos
    updateBarChart(filteredData);
    updateScatterPlot(filteredData);
    updateDataTable(filteredData);
}

function updateBarChart(data) {
    // Ordenar datos por la métrica seleccionada
    const sortedData = [...data].sort((a, b) => b[currentFilters.metric] - a[currentFilters.metric]);
    const topData = sortedData.slice(0, currentFilters.topN);
    
    const trace = {
        x: topData.map(d => d.Country),
        y: topData.map(d => d[currentFilters.metric]),
        type: 'bar'
    };

    const layout = {
        title: `Top ${currentFilters.topN} Países - ${currentFilters.metric}`,
        xaxis: { title: 'País' },
        yaxis: { title: currentFilters.metric },
        plot_bgcolor: 'rgba(30,30,30,0.66)',
        paper_bgcolor: 'rgba(30,30,30,0.66)',
        font:{
            color:'white',
            size:16
        }
    };

    Plotly.newPlot('barChart', [trace], layout);
}

function updateScatterPlot(data) {
    const xMetric = 'Economy (GDP per Capita)';
    const yMetric = 'Happiness Score';
    
    const trace = {
        x: data.map(d => d[xMetric]),
        y: data.map(d => d[yMetric]),
        mode: 'markers',
        type: 'scatter',
        text: data.map(d => d.Country),
        marker: {
            size: 8,
            color: data.map(d => d['Happiness Score']),
            colorscale: 'Viridis',
            showscale: true
        }
    };

    const layout = {
        title: `${yMetric} vs ${xMetric}`,
        xaxis: { title: xMetric },
        yaxis: { title: yMetric },
        plot_bgcolor: 'rgba(30,30,30,0.66)',
        paper_bgcolor: 'rgba(30,30,30,0.66)',
        font:{
            color:'white',
            size:16
        }
    };

    Plotly.newPlot('scatterPlot', [trace], layout);
}

function updateDataTable(data) {
    const sortedData = [...data].sort((a, b) => b[currentFilters.metric] - a[currentFilters.metric]);
    const topData = sortedData.slice(0, currentFilters.topN);
    
    const tableBody = document.getElementById('tableBody');
    tableBody.innerHTML = '';
    
    topData.forEach(country => {
        const row = document.createElement('tr');
        row.innerHTML = `
            <td>${country.Country}</td>
            <td>${country.Region}</td>
            <td>${country['Happiness Score'].toFixed(3)}</td>
            <td>${country['Economy (GDP per Capita)'].toFixed(3)}</td>
            <td>${country.Family.toFixed(3)}</td>
            <td>${country['Health (Life Expectancy)'].toFixed(3)}</td>
            <td>${country.Freedom.toFixed(3)}</td>
        `;
        tableBody.appendChild(row);
    });
}
</script>

<style>
.filters {
    margin-bottom: 20px;
}

.filters label, .filters select, .filters button {
    margin-right: 10px;
}

.table-container {
    margin-top: 20px;
}

table {
    width: 100%;
    border-collapse: collapse;
}

th, td {
    border: 1px solid #ddd;
    padding: 8px;
    text-align: left;
}

th {
    background-color: #353535;
}
</style>
{% endblock %}